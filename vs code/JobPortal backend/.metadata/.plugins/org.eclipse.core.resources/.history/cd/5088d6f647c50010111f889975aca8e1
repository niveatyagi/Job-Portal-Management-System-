package com.jobporta.service;

import com.jobporta.dto.ApplyJobRequest;
import com.jobporta.entity.JobApplication;
import com.jobporta.repository.JobApplicationRepository;
import com.jobporta.utility.FileUploadUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class JobApplicationServiceImpl implements JobApplicationService {

    private final JobApplicationRepository repo;

    @Override
    public JobApplication applyForJob(ApplyJobRequest request) throws Exception {

        // Validation
        if (request == null) {
            throw new IllegalArgumentException("Request cannot be null");
        }

        if (request.getUserId() == null || request.getJobId() == null) {
            throw new IllegalArgumentException("User ID and Job ID cannot be null");
        }

        String resumePath = null;

        // Upload resume
        if (request.getResume() != null && !request.getResume().isEmpty()) {
            resumePath = FileUploadUtil.saveResume(request.getResume());
        }

        JobApplication app = JobApplication.builder()
                .userId(request.getUserId())
                .jobId(request.getJobId())
                .fullName(request.getFullName())
                .email(request.getEmail())
                .address(request.getAddress())
                .role(request.getRole())
                .previousEmployers(request.getPreviousEmployers())
                .countryCode(request.getCountryCode())
                .phone(request.getPhone())
                .skills(request.getSkills())
                .availability(request.getAvailability())
                .resumePath(resumePath)
                .status("APPLIED")
                .build();

        return repo.save(app);
    }

    @Override
    public JobApplication updateStatus(String applicationId, String status) {

        if (status == null || status.isEmpty()) {
            throw new IllegalArgumentException("Status cannot be empty");
        }

        JobApplication app = repo.findById(applicationId)
                .orElseThrow(() -> new RuntimeException("Application Not Found"));

        app.setStatus(status);
        return repo.save(app);
    }

    @Override
    public JobApplication getById(String applicationId) {

        return repo.findById(applicationId)
                .orElseThrow(() -> new RuntimeException("Application Not Found"));
    }
}
